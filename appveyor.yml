version: 1.0.{build}

# Define build matrices for Windows and macOS
environment:
  matrix:
    - COMPILER: cl
      PLATFORM: x64
      MSYS2_ARCH: x86_64
      MSYS2_DIR: msys64
      MSYSTEM: MINGW64
      BIT: 64
      PATH: 'C:\%MSYS2_DIR%\%MSYSTEM%\bin;C:\%MSYS2_DIR%\usr\bin;%PATH%'
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2022  # Windows image
    - APPVEYOR_BUILD_WORKER_IMAGE: macOS             # macOS image

# Issue 529: Added install block
install:
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -eq 'macOS') { brew update; brew install qt@5; brew link qt5 --force; set PATH=/opt/homebrew/opt/qt@5/bin:$PATH }
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -ne 'macOS') { set QTDIR=C:\Qt\5.15.2\mingw81_64; set PATH=%PATH%;C:\Qt\5.15.2\mingw81_64\bin;C:\MinGW\bin;C:\Qt\Tools\mingw64\bin }

build_script:
  # Get submodules
  - git submodule update --init --recursive

  # Set path (Windows only)
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -ne 'macOS') { SET "PATH=C:\%MSYS2_DIR%\%MSYSTEM%\bin;C:\%MSYS2_DIR%\usr\bin;%PATH%" }

  # Install zlib (Windows only)
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -ne 'macOS') { bash -lc "pacman -S --needed --noconfirm zlib-devel" }

  # Install sqlite3 (Windows only)
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -ne 'macOS') { bash -lc "pacman -S --needed --noconfirm mingw64/mingw-w64-x86_64-sqlite3" }

  # Build MAVEN
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -ne 'macOS') { bash -lc "cd $APPVEYOR_BUILD_FOLDER; qmake CONFIG+=release -r build.pro"; bash -lc "cd $APPVEYOR_BUILD_FOLDER; make -j2"; bash -lc "cd $APPVEYOR_BUILD_FOLDER; make INSTALL_ROOT=appdir install" }
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -eq 'macOS') { qmake CONFIG+=release -r build.pro; make -j2; make INSTALL_ROOT=appdir install }

  # Issue 737: Search for peakdetector executable (Windows only)
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -ne 'macOS') { bash -lc "find . -name 'peakdetector.exe'" }

  # Print contents
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -ne 'macOS') { bash -lc "cd $APPVEYOR_BUILD_FOLDER; ls src/maven/appdir/bin/" }

after_build:
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -ne 'macOS') { 
        SET "PATH=C:\%MSYS2_DIR%\%MSYSTEM%\bin;C:\%MSYS2_DIR%\usr\bin;%PATH%"
        ./make_dist_win32.sh src/maven/appdir/bin/Maven.exe
        ./make_dist_win32.sh src/peakdetector/appdir/bin/peakdetector.exe 
      }
  - ps: if ($env:APPVEYOR_BUILD_WORKER_IMAGE -eq 'macOS') { 
        hdiutil create -volname Maven -srcfolder src/maven/appdir/bin/Maven.app -ov -format UDZO Maven.dmg
        hdiutil create -volname peakdetector -srcfolder src/peakdetector/appdir/bin/peakdetector.app -ov -format UDZO peakdetector.dmg
        7z a Maven.zip Maven.dmg
        7z a peakdetector.zip peakdetector.dmg
      }

artifacts:
  - path: dist/Maven*.zip
    name: Maven-windows
  - path: Maven.zip
    name: Maven-macOS
  - path: dist/peakdetector*.zip
    name: peakdetector-windows
  - path: peakdetector.zip
    name: peakdetector-macOS

deploy:
  - provider: GitHub
    description: 'Maven Desktop Application - Windows'
    auth_token:
        secure: dUsKwa2HNyEycsQtwtVQ9g7tXTQNjXzpf7FEBMllM69nbd1FC0PwcsC4IMGqHdRn # encrypted token from GitHub
    artifact: /Maven.*\.zip/           # upload Maven zip archive to release assets
    draft: false
    prerelease: false
    on:
      appveyor_repo_tag: true          # deploy on tag push only

  - provider: GitHub
    description: 'Peakdetector Executable - Windows'
    auth_token:
        secure: dUsKwa2HNyEycsQtwtVQ9g7tXTQNjXzpf7FEBMllM69nbd1FC0PwcsC4IMGqHdRn # encrypted token from GitHub
    artifact: /peakdetector.*\.zip/     # upload peakdetector zip archive to release assets
    draft: false
    prerelease: false
    on:
      appveyor_repo_tag: true          # deploy on tag push only

  - provider: GitHub
    description: 'Maven Desktop Application - macOS'
    auth_token:
        secure: dUsKwa2HNyEycsQtwtVQ9g7tXTQNjXzpf7FEBMllM69nbd1FC0PwcsC4IMGqHdRn # encrypted token from GitHub
    artifact: /Maven.*\.zip/           # upload Maven zip archive to release assets
    draft: false
    prerelease: false
    on:
      appveyor_repo_tag: true          # deploy on tag push only

  - provider: GitHub
    description: 'Peakdetector Executable - macOS'
    auth_token:
        secure: dUsKwa2HNyEycsQtwtVQ9g7tXTQNjXzpf7FEBMllM69nbd1FC0PwcsC4IMGqHdRn # encrypted token from GitHub
    artifact: /peakdetector.*\.zip/     # upload peakdetector zip archive to release assets
    draft: false
    prerelease: false
    on:
      appveyor_repo_tag: true          # deploy on tag push only